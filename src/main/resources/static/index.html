<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrant Health Management System</title>
</head>
<body>
    <h1>Migrant Health Management System</h1>
    
    <div id="navigation">
        <button onclick="showSection('patients')">Patients</button>
        <button onclick="showSection('records')">Medical Records</button>
    </div>

    <!-- PATIENTS SECTION -->
    <div id="patients-section">
        <h2>Patient Management</h2>
        
        <div>
            <h3>Add New Patient</h3>
            <form id="patient-form">
                <input type="text" id="p-firstName" placeholder="First Name" required>
                <input type="text" id="p-lastName" placeholder="Last Name" required>
                <input type="email" id="p-email" placeholder="Email" required>
                <input type="tel" id="p-phoneNumber" placeholder="Phone Number" required>
                <input type="date" id="p-dateOfBirth" placeholder="Date of Birth">
                <input type="text" id="p-address" placeholder="Address">
                <input type="text" id="p-nationality" placeholder="Nationality">
                <select id="p-gender">
                    <option value="">Select Gender</option>
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                    <option value="OTHER">Other</option>
                </select>
                <button type="submit">Add Patient</button>
            </form>
        </div>

        <div>
            <h3>Search Patients</h3>
            <input type="text" id="patient-search" placeholder="Search by name or email">
            <button onclick="searchPatients()">Search</button>
            <button onclick="loadAllPatients()">Show All</button>
        </div>

        <div>
            <h3>Patients List</h3>
            <table id="patients-table" border="1">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>DOB</th>
                        <th>Nationality</th>
                        <th>Gender</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="patients-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- MEDICAL RECORDS SECTION -->
    <div id="records-section" style="display:none;">
        <h2>Medical Records Management</h2>
        
        <div>
            <h3>Add New Medical Record</h3>
            <form id="record-form">
                <input type="number" id="r-patientId" placeholder="Patient ID" required>
                <input type="text" id="r-diagnosis" placeholder="Diagnosis" required>
                <textarea id="r-symptoms" placeholder="Symptoms" rows="3"></textarea>
                <textarea id="r-treatment" placeholder="Treatment" rows="3"></textarea>
                <input type="text" id="r-doctorName" placeholder="Doctor Name">
                <input type="datetime-local" id="r-visitDate">
                <button type="submit">Add Record</button>
            </form>
        </div>

        <div>
            <h3>Search Medical Records</h3>
            <input type="text" id="record-search" placeholder="Search diagnosis, symptoms, treatment">
            <button onclick="searchRecords()">Search</button>
            <button onclick="loadAllRecords()">Show All</button>
            <br><br>
            <input type="number" id="patient-id-filter" placeholder="Filter by Patient ID">
            <button onclick="filterByPatient()">Filter by Patient</button>
            <input type="text" id="doctor-name-filter" placeholder="Filter by Doctor">
            <button onclick="filterByDoctor()">Filter by Doctor</button>
        </div>

        <div>
            <h3>Medical Records List</h3>
            <table id="records-table" border="1">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Patient ID</th>
                        <th>Diagnosis</th>
                        <th>Symptoms</th>
                        <th>Treatment</th>
                        <th>Doctor</th>
                        <th>Visit Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="records-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="message" style="margin-top: 20px; padding: 10px; display: none;"></div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let editingPatientId = null;
        let editingRecordId = null;

        // Show/Hide sections
        function showSection(section) {
            document.getElementById('patients-section').style.display = section === 'patients' ? 'block' : 'none';
            document.getElementById('records-section').style.display = section === 'records' ? 'block' : 'none';
            
            if (section === 'patients') loadAllPatients();
            if (section === 'records') loadAllRecords();
        }

        // Show messages
        function showMessage(msg, isError = false) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.style.display = 'block';
            msgDiv.style.backgroundColor = isError ? '#ffcccc' : '#ccffcc';
            msgDiv.style.color = isError ? '#cc0000' : '#006600';
            setTimeout(() => msgDiv.style.display = 'none', 3000);
        }

        // PATIENT FUNCTIONS
        document.getElementById('patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const patient = {
                firstName: document.getElementById('p-firstName').value,
                lastName: document.getElementById('p-lastName').value,
                email: document.getElementById('p-email').value,
                phoneNumber: document.getElementById('p-phoneNumber').value,
                dateOfBirth: document.getElementById('p-dateOfBirth').value || null,
                address: document.getElementById('p-address').value || null,
                nationality: document.getElementById('p-nationality').value || null,
                gender: document.getElementById('p-gender').value || null
            };

            try {
                const url = editingPatientId 
                    ? `${API_BASE}/patients/${editingPatientId}`
                    : `${API_BASE}/patients`;
                const method = editingPatientId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patient)
                });

                if (response.ok) {
                    showMessage(editingPatientId ? 'Patient updated!' : 'Patient added!');
                    document.getElementById('patient-form').reset();
                    editingPatientId = null;
                    loadAllPatients();
                } else {
                    const error = await response.text();
                    showMessage(error, true);
                }
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        });

        async function loadAllPatients() {
            try {
                const response = await fetch(`${API_BASE}/patients`);
                const patients = await response.json();
                displayPatients(patients);
            } catch (error) {
                showMessage('Error loading patients: ' + error.message, true);
            }
        }

        async function searchPatients() {
            const term = document.getElementById('patient-search').value;
            if (!term) {
                loadAllPatients();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/patients/search?term=${encodeURIComponent(term)}`);
                const patients = await response.json();
                displayPatients(patients);
            } catch (error) {
                showMessage('Error searching patients: ' + error.message, true);
            }
        }

        function displayPatients(patients) {
            const tbody = document.getElementById('patients-tbody');
            tbody.innerHTML = '';

            patients.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.firstName} ${p.lastName}</td>
                    <td>${p.email}</td>
                    <td>${p.phoneNumber}</td>
                    <td>${p.dateOfBirth || 'N/A'}</td>
                    <td>${p.nationality || 'N/A'}</td>
                    <td>${p.gender || 'N/A'}</td>
                    <td>${p.address || 'N/A'}</td>
                    <td>
                        <button onclick="editPatient(${p.id})">Edit</button>
                        <button onclick="deletePatient(${p.id})">Delete</button>
                        <button onclick="viewPatientRecords(${p.id})">View Records</button>
                    </td>
                `;
            });
        }

        async function editPatient(id) {
            try {
                const response = await fetch(`${API_BASE}/patients/${id}`);
                const patient = await response.json();
                
                document.getElementById('p-firstName').value = patient.firstName;
                document.getElementById('p-lastName').value = patient.lastName;
                document.getElementById('p-email').value = patient.email;
                document.getElementById('p-phoneNumber').value = patient.phoneNumber;
                document.getElementById('p-dateOfBirth').value = patient.dateOfBirth || '';
                document.getElementById('p-address').value = patient.address || '';
                document.getElementById('p-nationality').value = patient.nationality || '';
                document.getElementById('p-gender').value = patient.gender || '';
                
                editingPatientId = id;
                showMessage('Editing patient. Click Add Patient to save changes.');
            } catch (error) {
                showMessage('Error loading patient: ' + error.message, true);
            }
        }

        async function deletePatient(id) {
            if (!confirm('Are you sure you want to delete this patient?')) return;

            try {
                const response = await fetch(`${API_BASE}/patients/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('Patient deleted!');
                    loadAllPatients();
                } else {
                    showMessage('Error deleting patient', true);
                }
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        function viewPatientRecords(patientId) {
            showSection('records');
            document.getElementById('patient-id-filter').value = patientId;
            filterByPatient();
        }

        // MEDICAL RECORD FUNCTIONS
        document.getElementById('record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const record = {
                diagnosis: document.getElementById('r-diagnosis').value,
                symptoms: document.getElementById('r-symptoms').value || null,
                treatment: document.getElementById('r-treatment').value || null,
                doctorName: document.getElementById('r-doctorName').value || null,
                visitDate: document.getElementById('r-visitDate').value || null
            };

            const patientId = document.getElementById('r-patientId').value;

            try {
                const url = editingRecordId 
                    ? `${API_BASE}/medical-records/${editingRecordId}`
                    : `${API_BASE}/medical-records/patient/${patientId}`;
                const method = editingRecordId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });

                if (response.ok) {
                    showMessage(editingRecordId ? 'Record updated!' : 'Record added!');
                    document.getElementById('record-form').reset();
                    editingRecordId = null;
                    loadAllRecords();
                } else {
                    const error = await response.text();
                    showMessage(error, true);
                }
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        });

        async function loadAllRecords() {
            try {
                const response = await fetch(`${API_BASE}/medical-records`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                showMessage('Error loading records: ' + error.message, true);
            }
        }

        async function searchRecords() {
            const term = document.getElementById('record-search').value;
            if (!term) {
                loadAllRecords();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/medical-records/search?term=${encodeURIComponent(term)}`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                showMessage('Error searching records: ' + error.message, true);
            }
        }

        async function filterByPatient() {
            const patientId = document.getElementById('patient-id-filter').value;
            if (!patientId) {
                showMessage('Please enter a patient ID', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/medical-records/patient/${patientId}`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                showMessage('Error filtering records: ' + error.message, true);
            }
        }

        async function filterByDoctor() {
            const doctorName = document.getElementById('doctor-name-filter').value;
            if (!doctorName) {
                showMessage('Please enter a doctor name', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/medical-records/doctor/${encodeURIComponent(doctorName)}`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                showMessage('Error filtering records: ' + error.message, true);
            }
        }

        function displayRecords(records) {
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';

            records.forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${r.id}</td>
                    <td>${r.patient ? r.patient.id : 'N/A'}</td>
                    <td>${r.diagnosis}</td>
                    <td>${r.symptoms || 'N/A'}</td>
                    <td>${r.treatment || 'N/A'}</td>
                    <td>${r.doctorName || 'N/A'}</td>
                    <td>${r.visitDate ? new Date(r.visitDate).toLocaleString() : 'N/A'}</td>
                    <td>
                        <button onclick="editRecord(${r.id})">Edit</button>
                        <button onclick="deleteRecord(${r.id})">Delete</button>
                    </td>
                `;
            });
        }

        async function editRecord(id) {
            try {
                const response = await fetch(`${API_BASE}/medical-records/${id}`);
                const record = await response.json();
                
                document.getElementById('r-patientId').value = record.patient ? record.patient.id : '';
                document.getElementById('r-diagnosis').value = record.diagnosis;
                document.getElementById('r-symptoms').value = record.symptoms || '';
                document.getElementById('r-treatment').value = record.treatment || '';
                document.getElementById('r-doctorName').value = record.doctorName || '';
                document.getElementById('r-visitDate').value = record.visitDate ? record.visitDate.substring(0, 16) : '';
                
                editingRecordId = id;
                showMessage('Editing record. Click Add Record to save changes.');
            } catch (error) {
                showMessage('Error loading record: ' + error.message, true);
            }
        }

        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            try {
                const response = await fetch(`${API_BASE}/medical-records/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('Record deleted!');
                    loadAllRecords();
                } else {
                    showMessage('Error deleting record', true);
                }
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        // Load patients on page load
        window.onload = () => loadAllPatients();
    </script>
</body>
</html>