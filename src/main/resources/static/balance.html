<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedLink - Medical Records</title>
</head>
<body style="font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f9;">

  <div>
    <!-- Navbar -->
    <nav style="background: #00796B; color: white; display: flex; justify-content: space-between; align-items: center; padding: 15px 25px;">
      <h1 style="margin: 0; font-size: 22px;">Medical Records</h1>
      <div>
        <a href="home.html" style="color: white; text-decoration: none; margin-right: 15px; font-weight: bold;">Back to Home</a>
        <button onclick="logout()" style="background: #e53935; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer;">Logout</button>
      </div>
    </nav>

    <!-- Search Section -->
    <div style="padding: 20px; background: #fff; margin: 20px auto; max-width: 900px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
      <h2 style="margin-bottom: 15px; color: #333;">Search Medical Records</h2>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="searchInput" placeholder="Search by diagnosis, symptoms, or treatment..."
               style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button onclick="searchRecords()" style="background: #00796B; color: white; border: none; padding: 10px 16px; border-radius: 5px; cursor: pointer;">Search</button>
        <button onclick="loadAllRecords()" style="background: #555; color: white; border: none; padding: 10px 16px; border-radius: 5px; cursor: pointer;">Show All</button>
      </div>
    </div>

    <!-- Records Section -->
    <div style="padding: 20px; max-width: 900px; margin: auto;">
      <h2 style="color: #333;">Your Medical Records</h2>
      <div id="recordsContainer" style="margin-top: 15px;"></div>
    </div>

    <!-- Edit Record Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 8px; width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h3 style="margin-bottom: 15px; color: #00796B;">Edit Medical Record</h3>
        <form id="editRecordForm" style="display: flex; flex-direction: column; gap: 12px;">
          <div>
            <label for="editDiagnosis" style="display: block; margin-bottom: 5px;">Diagnosis:</label>
            <input type="text" id="editDiagnosis" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          </div>
          <div>
            <label for="editSymptoms" style="display: block; margin-bottom: 5px;">Symptoms:</label>
            <textarea id="editSymptoms" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
          </div>
          <div>
            <label for="editTreatment" style="display: block; margin-bottom: 5px;">Treatment:</label>
            <textarea id="editTreatment" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
          </div>
          <div>
            <label for="editDoctorName" style="display: block; margin-bottom: 5px;">Doctor Name:</label>
            <input type="text" id="editDoctorName" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          </div>
          <div>
            <label for="editVisitDate" style="display: block; margin-bottom: 5px;">Visit Date:</label>
            <input type="datetime-local" id="editVisitDate" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button type="submit" style="background: #00796B; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer;">Update Record</button>
            <button type="button" onclick="closeEditModal()" style="background: #999; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- âœ… Your JS remains same -->
  <script>
    let currentPatient = null;
    let currentEditingRecordId = null;

    window.onload = function() {
      const patientData = localStorage.getItem('currentPatient');
      if (!patientData) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }
      currentPatient = JSON.parse(patientData);
      loadAllRecords();
    };

    async function loadAllRecords() {
      try {
        const response = await fetch(`http://localhost:8080/api/medical-records/patient/${currentPatient.id}`);
        const records = await response.json();
        displayRecords(records);
      } catch (error) {
        console.error('Error loading records:', error);
        document.getElementById('recordsContainer').innerHTML = '<p style="color:red;">Error loading records.</p>';
      }
    }

    async function searchRecords() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (!searchTerm) {
        loadAllRecords();
        return;
      }

      try {
        const response = await fetch(`http://localhost:8080/api/medical-records/search?term=${encodeURIComponent(searchTerm)}`);
        const allRecords = await response.json();
        const patientRecords = allRecords.filter(record => record.patient.id === currentPatient.id);
        displayRecords(patientRecords);
      } catch (error) {
        console.error('Error searching records:', error);
        document.getElementById('recordsContainer').innerHTML = '<p style="color:red;">Error searching records.</p>';
      }
    }

    function displayRecords(records) {
      const container = document.getElementById('recordsContainer');
      if (records.length === 0) {
        container.innerHTML = '<p>No medical records found.</p>';
        return;
      }
      container.innerHTML = records.map(record => `
        <div style="border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1; color: #333;">
              <h3 style="margin: 0 0 10px 0; color: #00796B;">Diagnosis: ${record.diagnosis}</h3>
              <p><strong>Doctor:</strong> ${record.doctorName}</p>
              <p><strong>Visit Date:</strong> ${new Date(record.visitDate).toLocaleString()}</p>
              <p><strong>Symptoms:</strong> ${record.symptoms || 'Not specified'}</p>
              <p><strong>Treatment:</strong> ${record.treatment || 'Not specified'}</p>
              <p><strong>Created:</strong> ${new Date(record.createdAt).toLocaleString()}</p>
              <p><strong>Last Updated:</strong> ${new Date(record.updatedAt).toLocaleString()}</p>
            </div>
            <div>
              <button onclick="editRecord(${record.id})" style="background:#00796B; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Edit</button>
              <button onclick="deleteRecord(${record.id})" style="background:#e53935; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-left:5px;">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function editRecord(recordId) {
      try {
        const response = await fetch(`http://localhost:8080/api/medical-records/${recordId}`);
        const record = await response.json();
        currentEditingRecordId = recordId;
        document.getElementById('editDiagnosis').value = record.diagnosis;
        document.getElementById('editSymptoms').value = record.symptoms || '';
        document.getElementById('editTreatment').value = record.treatment || '';
        document.getElementById('editDoctorName').value = record.doctorName;
        document.getElementById('editVisitDate').value = record.visitDate.slice(0, 16);
        document.getElementById('editModal').style.display = 'block';
      } catch (error) {
        console.error('Error loading record for edit:', error);
        alert('Error loading record for editing');
      }
    }

    document.getElementById('editRecordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const updatedRecord = {
        diagnosis: document.getElementById('editDiagnosis').value,
        symptoms: document.getElementById('editSymptoms').value,
        treatment: document.getElementById('editTreatment').value,
        doctorName: document.getElementById('editDoctorName').value,
        visitDate: document.getElementById('editVisitDate').value
      };
      try {
        const response = await fetch(`http://localhost:8080/api/medical-records/${currentEditingRecordId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedRecord)
        });
        if (response.ok) {
          alert('Record updated successfully!');
          closeEditModal();
          loadAllRecords();
        } else {
          const errorText = await response.text();
          alert(`Error updating record: ${errorText}`);
        }
      } catch (error) {
        console.error('Error updating record:', error);
        alert('Failed to update record');
      }
    });

    async function deleteRecord(recordId) {
      if (!confirm('Are you sure you want to delete this medical record?')) return;
      try {
        const response = await fetch(`http://localhost:8080/api/medical-records/${recordId}`, { method: 'DELETE' });
        if (response.ok) {
          alert('Record deleted successfully!');
          loadAllRecords();
        } else {
          const errorText = await response.text();
          alert(`Error deleting record: ${errorText}`);
        }
      } catch (error) {
        console.error('Error deleting record:', error);
        alert('Failed to delete record');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditingRecordId = null;
    }

    function logout() {
      localStorage.removeItem('currentPatient');
      window.location.href = 'login.html';
    }

    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) closeEditModal();
    });
  </script>
</body>
</html>
